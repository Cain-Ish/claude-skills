{
  "rule_id": "bash-array-unbound-check",
  "version": "1.0.0",
  "category": "script-correctness",
  "severity": "error",
  "confidence": 0.95,
  "applies_to": {
    "component": "scripts",
    "pattern": ".*\\.sh$"
  },
  "validation": {
    "type": "static",
    "checks": [
      {
        "check_id": "array-with-set-u",
        "type": "pattern-match",
        "requires_all": [
          {
            "pattern": "set -[euo]*u",
            "description": "Script uses set -u strict mode"
          },
          {
            "pattern": "\\$\\{#[a-zA-Z_][a-zA-Z0-9_]*\\[@\\]\\}",
            "description": "Script accesses array length"
          }
        ],
        "requires_one_of": [
          {
            "pattern": "local [a-zA-Z_][a-zA-Z0-9_]*=\\(\\)",
            "description": "Array explicitly initialized"
          },
          {
            "pattern": "if \\[\\[ \\$\\{#[a-zA-Z_][a-zA-Z0-9_]*\\[@\\]\\} -gt 0 \\]\\]",
            "description": "Array length checked before access"
          }
        ],
        "error_message": "Script uses 'set -u' and accesses arrays without explicit initialization. This causes 'unbound variable' errors when arrays are empty. Initialize arrays with 'local array=()' before populating."
      }
    ]
  },
  "fix_template": {
    "type": "manual",
    "content": "Initialize array before population:\n```bash\n# Before:\nlocal my_array\nmy_array=($(some_command))\n\n# After:\nlocal my_array=()\nmy_array=($(some_command))\n\n# Add defensive check before loops:\nif [[ ${#my_array[@]} -gt 0 ]]; then\n    for item in \"${my_array[@]}\"; do\n        # process item\n    done\nfi\n```"
  },
  "impact": {
    "user_experience": "high",
    "description": "Causes script failures with 'unbound variable' error, especially on fresh installations or after cleanup"
  },
  "references": [
    "https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html",
    "https://github.com/Cain-Ish/claude-skills/issues/cleanup-unbound-variable"
  ],
  "learned_from": "user_feedback",
  "discovered_at": "2026-01-25",
  "last_updated": "2026-01-25"
}
